# CAN 通信

一个CAN帧包含多个字段：

### 数据帧（Data Frame）

数据帧用于传输从发送节点到接收节点的数据，结构包括：

**起始位：**表示帧的开始

**仲裁域：**包含**帧ID（标识符）**和 RTR 位（远程传输请求位，对于数据帧，这个位设置为0）。

**控制域：**包括数据长度代码（DLC），表示数据字段中数据的长度。

**数据域：**携带实际的数据，最多8字节。

**CRC域：**包含一个循环冗余校验序列，用于错误检测。

**确认域：**包括一个发送节点和接收节点用来确认收到消息的位。

**结束标志：**表示帧的结束。

### 远程帧（Remote Frame）

远程帧用于请求数据域。其结构与数据帧相似，但 RTR 位设置为1，表示这是一个请求帧，且不包含数据域。

### 错误帧（Error Frame）

当检测到错误的时候，任何节点都可以发送错误帧。错误帧会中断当前的传输，并请求重新发送。

### 过载帧（Overload Frame）

过载帧用于指示节点因为内部条件（如缓冲区满）而无法处理更多帧。这种帧会导致网络延迟，以便节点有时间处理累计的帧。



CAN 数据帧的总位数取决于它使用标准帧格式还是拓展帧格式，以及数据域的长度。下面是一个基于标准和扩展格式的详细分解，假设最大数据长度（8字节或64位）。

### 标准帧格式

- **起始位**：1位
- **仲裁域**：包括11位的标识符和1位的 RTR 位，共12位
- **控制域**：包括6位（其中4位用于数据长度代码（DLC））
- **数据域**：最多8字节，即64位
- **CRC域**：15位的 CRC 序列和1位的 CRC 分隔符，共16位
- **确认域**：包括1位的 ACK 槽和1位的 ACK 分隔符，共2位
- **结束标志**：7位

这给出了一个标准数据帧最大长度的基础计算：1 + 12 + 6 + 64 + 16 + 2 + 7 = 108 位（不包括数据域为0的情况和帧间隔）。

### 扩展帧格式

- **起始位**：1位

- **仲裁域**：包括11位基本标识符和18位扩展标识符（29位*）、1位 SRR（替代远程请求）、1位 IDE（标识符扩展位）和1位的 RTR 位，共32位

  *：这意味着最大的扩展标识符是`1FFFFFFF`（十六进制）或`11111111111111111111111111111`（二进制），这代表了29位。

- **控制域**：同样包括6位（包括4位DLC）

- **数据域**：最多8字节，即64位

- **CRC域**：15位的 CRC 序列和1位的 CRC 分隔符，共16位

- **确认域**：2位

- **结束标志**：7位

扩展帧的最大长度计算为：1 + 31 + 6 + 64 + 16 + 2 + 7 = 127 位（同样，不包括数据域为0的情况和帧间隔）。

这些计算提供了在最大数据长度情况下标准帧和扩展帧的理论最大位数。实际位数将根据数据域的实际长度以及是否有额外的错误标志或过载标志等因素有所变化。



### **SRR（Substitute Remote Request）**

- SRR位是在CAN拓展帧（Extended Frame）中特有的。它被设置为1来指示一个数据帧的标识符扩展位（Extended Identifier Bit）在拓展帧中是有效的。
- 当SRR位被设置为1时，它表示这个数据帧的标识符的高位扩展位（29位ID中的高11位）有效，而不是使用标准帧的11位ID。
- 拓展帧中，如果一个数据帧的SRR位被设置为1，则表示这个数据帧的标识符是一个扩展帧标识符。



### **DLC（Data Length Code）**

在CAN通信协议中，DLC 表示数据字段的长度，是CAN帧控制域的一部分。DLC的主要作用是指示随后数据字段中的数据字节数。由于CAN协议规定数据字段的最大长度为8字节，DLC允许发送方指定实际发送的数据量，从0到8字节。

#### 作用

- **指示数据长度**：DLC明确告诉接收节点数据字段中包含的数据量，确保数据的正确解析和处理。
- **灵活性**：通过DLC，CAN帧可以携带不同长度的数据，提高了网络的灵活性和效率。这对于需要传输不同大小数据的应用来说非常有用。
- **效率**：允许发送不到最大长度的数据帧，有助于提高网络的数据传输效率，特别是在数据量较小的情况下。

#### 使用方法

当构建一个CAN数据帧以发送数据时，发送节点需要设置DLC以反映数据字段中实际包含的字节数。这个步骤通常是发送数据的过程中的一部分：

1. **确定数据长度**：根据将要发送的实际数据量，确定DLC的值。例如，如果你要发送3字节的数据，DLC应设置为3。
2. **设置DLC**：在构建CAN帧时，将控制域中的DLC部分设置为上一步确定的值。
3. **填充数据字段**：根据DLC指示的长度，将数据填充到数据字段中。如果数据少于8字节，只需填充实际的数据量。
4. **发送帧**：完成构建后，帧就可以发送到CAN网络上去了。接收节点将使用DLC来确定如何解析接收到的数据字段。

#### 注意事项

- **数据一致性**：发送节点必须确保DLC的值与数据字段中实际的数据量一致。错误的DLC值可能导致接收节点错误地解析数据，从而导致数据错误或丢失。
- **标准和扩展**：无论是使用标准帧格式还是扩展帧格式，DLC的使用方法都是相同的。
- **兼容性**：在设计CAN通信系统时，所有的节点都必须能够正确地解释和处理DLC，以确保网络上的有效通信。



#### 标识符的作用

#### 1. 消息优先级

- **优先级定义**：在CAN网络中，帧ID的数值越低，其优先级越高。这意味着，当网络上的多个设备同时尝试发送消息时，具有最低帧ID的消息将被首先传输。这种非破坏性的仲裁机制确保了关键消息的及时传输，而无需额外的优先级信号线。
- **高效的冲突解决**：这种基于优先级的方法允许CAN网络在不丢失任何消息的情况下高效解决消息传输冲突。

#### 2. 消息内容标识

- **消息识别**：标识符不仅用于定义消息优先级，还用于指示消息的内容或目的。接收节点根据收到的帧ID来识别消息内容，并据此决定如何处理该消息。
- **网络管理**：通过为不同类型的消息分配不同的帧ID，网络上的节点可以灵活地发送和接收多种数据，而不需要事先的复杂配置或协商。

#### 标识符的使用

#### 设定和识别

- 在设计CAN网络和其通信协议时，开发者会根据应用需求预先定义每个消息类型的帧ID。这包括为特定的数据读取、控制命令、状态更新等分配唯一的标识符。
- 设备在发送消息时，会根据消息的类型设置对应的帧ID。接收方设备则根据这个帧ID识别消息内容，并执行相应的处理逻辑。

#### 网络设计考虑

- **标识符分配**：合理地分配帧ID对于网络的高效运行至关重要。需要考虑消息的重要性，确保关键消息有较高的传输优先级。
- **灵活性与扩展性**：在为消息分配帧ID时，还应考虑网络的未来扩展。保留一定范围的帧ID用于未来可能增加的消息类型，可以提高网络的灵活性和可扩展性。



![filter.png](https://github.com/Eggze2/Notes/blob/main/Notes/STM32/can%E9%80%9A%E4%BF%A1/filter.png?raw=true)

### 掩码（Mask）

### *==简单来说：Filter = 模板   Mask = 0 = 忽略 Mask = 1 = 匹配==*

Mask 是一种用于过滤接收消息的机制，它定义了哪些位需要匹配才能接收消息。这对于在特定应用中选择性地处理消息非常有用，尤其是在复杂系统中，如我们之前讨论的汽车网络场景。通过使用掩码，节点可以决定它对哪些消息感兴趣，从而仅处理那些相关的消息，而忽略其他消息。

#### 掩码的作用

在我们的汽车CAN网络例子中，设备可能只需要处理特定类型的消息，例如：

- 引擎控制单元（ECU）可能只对引擎数据感兴趣。
- 刹车系统可能只需要监听刹车系统状态消息。
- 娱乐系统只处理与自己相关的控制消息。

通过设置适当的掩码，每个设备可以配置其CAN接收器，仅当消息的帧ID与设定的模式匹配时，才接收该消息。

#### 如何使用掩码

掩码使用二进制位模式来定义哪些位需要匹配。在CAN系统中，"1"表示该位必须匹配，而"0"表示该位可以是任何值。

假设我们的系统中有以下需求：

- 刹车系统消息有最高优先级，其帧ID为`0x000`。
- 引擎数据消息的帧ID范围从`0x001`到`0x00F`。
- 娱乐系统消息的帧ID范围从`0x100`到`0x1FF`。

如果ECU只想接收引擎数据消息，我们可以这样设置掩码和过滤器：

- **过滤器**：设置为`0x001`，表示关注的消息帧ID的最低值。
- **掩码**：设置为`0xFFF0`，这意味着只有帧ID的最高12位必须匹配，最低4位可以是任何值（因为`0xF`二进制为`1111`）。这样，任何`0x001`到`0x00F`范围内的帧ID都会被接收。

对于刹车系统，由于其消息帧ID为`0x000`，我们可能设置：

- **过滤器**：`0x000`
- **掩码**：`0xFFFF`，确保只有完全匹配`0x000`的消息会被接收。

而娱乐系统想要接收的帧ID范围更广，可以设置掩码来匹配更宽的范围：

- **过滤器**：`0x100`
- **掩码**：`0xFF00`，这意味着只有帧ID的高8位需要匹配，允许`0x100`到`0x1FF`之间的任何帧ID的消息被接收。

通过这种方式，每个系统或设备能够根据其需要接收和处理的消息类型，设置相应的掩码和过滤器，优化数据处理流程，并减少不必要的数据处理负担。



### 标准CAN数据帧结构

假设我们有一个标准CAN数据帧，用于传输引擎温度信息。引擎温度是以摄氏度为单位，假设当前温度为90°C，我们将这个值转换为二进制编码发送。

1. **起始位 (1位)**：表示帧的开始，总是为0。
2. 仲裁域 (12位)
   - **标识符 (11位)**：假设引擎温度的帧ID为`0x0F3`（二进制：`000011110011`），用于标识消息内容。
   - **RTR位 (1位)**：远程传输请求位，对于数据帧，这个位为0，表示这是一个数据帧而非远程请求帧。
3. 控制域 (6位)
   - **IDE位 (1位)**：标识符扩展位，对于标准帧，此位为0。
   - **r0位 (1位)**：保留位，用于未来使用，当前设置为0。
   - **DLC (4位)**：数据长度代码，表示数据字段的长度。假设温度值占用2字节，DLC为`0010`。
4. **数据域 (0-64位)**：携带实际数据，对于这个例子，我们用两个字节（16位）表示温度值`90°C`。假设温度值以每度1单位编码，`90°C`可编码为`0000000101101010`。
5. **CRC域 (15位+1位CRC分隔符)**：用于错误检测的循环冗余校验序列及其分隔符。
6. 确认域 (2位)
   - **ACK槽 (1位)**：发送节点将此位设置为1，接收节点在成功接收帧后写入0。
   - **ACK分隔符 (1位)**：固定为1，用于分隔。
7. **结束标志 (7位)**：表示帧的结束，固定为`0111111`。

### 示例

假设的数据帧结构（以二进制形式）简化表示为：

- 起始位: `0`
- 仲裁域: `000011110011 0` (标识符 `0x0F3` + RTR位)
- 控制域: `0 0 0010` (IDE位, r0位, DLC=2)
- 数据域: `0000000101101010` (90°C的温度值)
- CRC域, 确认域, 结束标志: 这些部分依赖于具体实现和传输过程，不便于此处简化表示。

通过这个结构，你可以看到CAN数据帧如何组织并传输具体的信息（如引擎温度）及其格式化方式。



在我们之前讨论的汽车CAN网络中，假设我们要设计一个系统，以便引擎控制单元（ECU）只接收与引擎相关的信息，例如引擎温度和转速。为此，我们设定了两个帧ID：`0x0F3`用于引擎温度，`0x0F4`用于引擎转速。现在，我们将设计一个掩码和过滤器，使得ECU只接收这两种类型的信息。

### 掩码和过滤器的设计

- **过滤器设置**：为了简化说明，我们假设过滤器被设置为`0x0F3`（二进制：`0000 1111 0011`），这是引擎温度消息的帧ID。
- **掩码设置**：我们将掩码设置为`0xFFE`（二进制：`1111 1111 1110`）。这个掩码告诉CAN控制器，忽略帧ID的最后一位，只比较前11位中的前10位。

### 掩码的作用解释

掩码中的“1”表示必须匹配的位，“0”表示可以忽略的位。在我们的例子中，掩码`0xFFE`（或二进制的`1111 1111 1110`）意味着在比较帧ID时，只有帧ID的最后一位可以不同。

这样，当ECU接收到任何CAN消息时，它会使用这个掩码来决定是否处理该消息：

- 如果一个消息的帧ID是`0x0F3`（引擎温度），当应用掩码后，ECU会发现它匹配过滤器设置（因为最后一位之前的所有位都匹配），因此它会接收并处理这个消息。
- 同样，如果帧ID是`0x0F4`（引擎转速），即使这不完全符合过滤器设置的值，应用掩码后最后一位被忽略，仍然会发现它与过滤器设置匹配，因此ECU也会接收并处理这个消息。

### 结果

通过这种方式，ECU能够接收到所有关于引擎温度和转速的消息，尽管它们有不同的帧ID。这种方法允许系统灵活地接收一组相关消息，而无需为每种消息类型单独设置过滤器，从而减少了系统的复杂性并提高了效率。



让我们来构造一个扩展CAN数据帧的实际例子，用于传输汽车的燃油压力数据。扩展CAN帧相比标准CAN帧包含一个更长的标识符，允许更多的消息类型和更细致的消息分类。在这个例子中，我们假设燃油压力传感器的数据需要通过CAN网络传输给汽车的中央控制系统，以监控燃油系统的健康状况。

### 扩展CAN数据帧结构

我们将使用一个29位的扩展标识符，其中燃油压力数据的帧ID设置为`0x1BCD020`（这是一个假想的值，实际应用中的ID将根据具体的系统设计而定）。以下是帧的各个部分及其作用的详细说明：

1. **起始位 (1位)**：标记帧开始的单个固定位，总是0。
2. **仲裁域 (32位)**：
   - **标识符 (29位)**：扩展标识符为`0x1BCD020`，用于唯一标识这个特定的消息类型（燃油压力）。
   - **SRR (Substitute Remote Request) (1位)**：在扩展帧中，这一位替代了标准帧中的RTR位，总是设置为1。
   - **IDE (Identifier Extension) (1位)**：表示这是一个扩展帧，设置为1。
   - **RTR (Remote Transmission Request) (1位)**：对于数据帧，这个位为0，表示这是包含数据的帧。
3. **控制域 (6位)**：
   - **保留位 (2位)**：保留未用，通常设置为0。
   - **DLC (Data Length Code) (4位)**：指示数据字段的长度。假设燃油压力值为2字节，则DLC为`0010`。
4. **数据域 (最多64位)**：携带实际数据，对于此例，假设燃油压力以两个字节表示，例如`0101 1100 1001 0000`（这只是一个示例值）。
5. **CRC域 (15位+1位CRC分隔符)**：包含一个循环冗余校验序列，用于检测传输错误。
6. **确认域 (2位)**：
   - **ACK槽 (1位)**：发送者将此位设置为1，接收者在成功接收帧后写入0以确认。
   - **ACK分隔符 (1位)**：固定为1，用于分隔。
7. **结束标志 (7位)**：表示帧的结束，固定为`0111111`。

### 示例

假设的扩展数据帧结构（以二进制形式）简化表示为：

- 起始位: `0`
- 仲裁域: `0001 1011 1100 1101 0000 0010 0000 1 1 0` (扩展标识符 `0x1BCD020` + SRR + IDE + RTR)
- 控制域: `00 0010` (保留位 + DLC=2)
- 数据域: `0101110010010000` (示例燃油压力值)
- CRC域, 确认域, 结束标志: 这些部分依赖于具体实现和传输过程，不便于此处简化表示。

通过这个结构，你可以看到扩展CAN数据帧如何组织并传输具体的信息（如燃油压力）及其格式化方式。